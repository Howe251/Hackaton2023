# Отчет о выполнении задачи "Дрон инспекто"

- [Отчет о выполнении задачи "Дрон инспекто"](#отчет-о-выполнении-задачи-дрон-инспекто)
  - [Постановка задачи](#постановка-задачи)
  - [Известные ограничения и вводные](#известные-ограничения-и-вводные)
    - [Цели и Предположения Безопасности (ЦПБ)](#цели-и-предположения-безопасности-цпб)
      - [Цели](#цели)
      - [Предположения](#предположения)
  - [Архитектура решения](#архитектура-решения)
    - [Компоненты](#компоненты)
    - [Алгоритм работы решения](#алгоритм-работы-решения)
      - [Монитор безопасности (security monitor)](#монитор-безопасности-security-monitor)
      - [Система планирования полетов](#система-планирования-полетов)
      - [Система организации воздужного движения](#система-организации-воздужного-движения)
      - [Дрон](#дрон)
  - [Безопасность](#безопасность)
    - [Выполнение целей безопасности](#выполнение-целей-безопасности)
      - [1. обеспечение безопасности дрона от перехвата управления](#1-обеспечение-безопасности-дрона-от-перехвата-управления)
      - [2. получение задания только от корпоративного сервера](#2-получение-задания-только-от-корпоративного-сервера)
      - [3. противодействие Dos-атакам](#3-противодействие-dos-атакам)
      - [4. (дополнительно) противодействие от взлома мобильного приложения с условием физического доступа](#4-дополнительно-противодействие-от-взлома-мобильного-приложения-с-условием-физического-доступа)
      - [(без номера). противодействие от взлома дрона с условием физического доступа](#без-номера-противодействие-от-взлома-дрона-с-условием-физического-доступа)
    - [Компрометация сервисов](#компрометация-сервисов)
      - [компрометация дрона](#компрометация-дрона)
      - [компрометация мобильного приложения](#компрометация-мобильного-приложения)
      - [компрометация управляющего центра](#компрометация-управляющего-центра)
    - [Рассмотрение других негативных сценариев (из задания)](#рассмотрение-других-негативных-сценариев-из-задания)
      - [Физический доступ к смартфону с мобильным приложением](#физический-доступ-к-смартфону-с-мобильным-приложением)
      - [Подключение к недоверенному роутеру. Атака через каналы связи](#подключение-к-недоверенному-роутеру-атака-через-каналы-связи)
      - [Недостаточная защита от подбора учетных данных](#недостаточная-защита-от-подбора-учетных-данных)
      - [Глушение канала передачи информации мобильное приложение \<--\> дрон](#глушение-канала-передачи-информации-мобильное-приложение----дрон)
      - [Перехват команды/полетного задания и внедрение в него недостоверной информации](#перехват-командыполетного-задания-и-внедрение-в-него-недостоверной-информации)
      - [DDoS-атака на управляющий центр](#ddos-атака-на-управляющий-центр)
    - [Итоговые изменения в архитектуре](#итоговые-изменения-в-архитектуре)
  - [Тестирование](#тестирование)
    - [Нормальная работа](#нормальная-работа)
      - [Включение дрона](#включение-дрона)
      - [Создание заданий](#создание-заданий)
      - [Запуск для работы](#запуск-для-работы)
      - [Получение информации о полете с мобильного телефона](#получение-информации-о-полете-с-мобильного-телефона)
      - [Принудительное возвращение на базу](#принудительное-возвращение-на-базу)
      - [Просмотр журналов управляющего центра об инцидентах](#просмотр-журналов-управляющего-центра-об-инцидентах)
    - [Cheat-запросы и функции](#cheat-запросы-и-функции)
      - [Состояние дрона](#состояние-дрона)
      - [Ошибка GPS навигации](#ошибка-gps-навигации)
      - [Человек под дроном](#человек-под-дроном)
    - [DoS-атака](#dos-атака)
    - [Обработка ошибок](#обработка-ошибок)
    


## Постановка задачи

Задача заключается в реализации ПО дрона, который автономно проводит мониторинг трубопроводов, таким образом, чтобы выполнение задач можно было считать безопасным как с программной точки зрения, так и с физической(безо столкновений и причинение ущерба).

## Известные ограничения и вводные

По условиям организаторов должна использоваться микросервисная архитектура и шина обмена сообщениями для реализации асинхронной работы сервисов.

### Цели и Предположения Безопасности (ЦПБ)

#### Цели 

1. Выполняются только аутентичные задания на мониторинг
2. Выполняются только авторизованные системой ОрВД задания
3. Все манёвры выполняются согласно ограничениям в полётном задании (высота, полётная зона/эшелон)
4. Только авторизованные получатели имеют доступ к сохранённым данным фото-видео фиксации
5. В случае критического отказа дрон снижается со скоростью не более 1 м/с
6. Для запроса авторизации вылета к системе ОрВД используется только аутентичный идентификатор дрона
7. Только авторизованные получатели имеют доступ к оперативной информации


#### Предположения

1. Аутентичная система ОрВД благонадёжна
2. Аутентичные сотрудники благонадёжны и обладают необходимой квалификацией
3. Только авторизованные сотрудники управляют системами
4. Аутентичное полётное задание составлено так, что на всём маршруте дрон может совершить аварийную посадку без причинения неприемлемого ущерба заказчику и третьим лицам


## Архитектура решения

### Компоненты

| Название | Назначение | 
|----|----|
|*Дрон* | Регистрирует БВС и отправляет информацию о местоположении. | 
|*Система планирования полетов*| Регистрация полетного задания. Отправка полетного залания на дрон. Отправляет статус о завершении полета. Отправляет оператору положение дрона и статус мониторинга. Отправляет оператору статус выполнения задания.|
|*Система организации воздушного движения*| Одобрение полета. Подтверждение вылета. |
|*Security monitor* (монитор безопасности)| Авторизует операцию, если она удовлетворяет заданным правилам или блокирует её в противном случае |
|*Message bus*| Брокер - сервис передачи сообщений от источника получателям |

Более подробное описание о функциях компонентов, логике их работы и методах взаимодействия см. ниже

![HLA](./images/img1.png "Архитектура общая")

### Алгоритм работы решения

![ARCH](./images/ "Архитектура")

#### Монитор безопасности (security monitor)

Для монитора безопасности был использован брокер сообщений kafka. Брокер сообщений не позволяет передавать и получать информацию у модулей, к которым закрыт доступ через политику конфеденциальности.

??? написать реализацию и логику работы.

#### Система планирования полетов

Реализация: 

Бизнес функции:
1. Проверка совместимости оператора и дрона
2. Проверка валидности задания
3. Отправка полетного задания в ОрВД
4. Отправка полетного задания дрону
5. Получение телеметрии от дрона в процессе выполнения задания
6. Отправка телеметрии **авторизованному** пользователю
7. Отправляет статус о заврешении полета в ОрВД
8. Отправляет статус о выполненной задаче оператору

Какие цели безопасности решает:
- Проверка оператора на доступ управления дроном, решает **цель безопасности №1**, т.к. сотрудник предполагаемо благонадежный, он может по случайности запросить управление не тем дроном.
- Проверка валидности задания при получении нового задания на мониторинг решает **цель безопасности №2**.
- **Цель безопаности №3** решается передачей дроном телеметрии при выполнении задания.
- **Цель безопаности №5** может быть решен передачей дроном телеметрии при выполнении задания.
- **Цель безопаности №7** решается тем, что опреативную информацию мы передаем только авторизованному пользователю

#### Система организации воздужного движения

Реализация:

Бизнес функции:
1. Получает полетное задание
2. Согласовывает вылета
3. Регистрирует БВС
4. Подтверждает вылет дрона
5. Получает информацию о местоположении при выполнении задания
6. Посылает экстренные команды при отклонении от курса

Какие цели безопаност решает:
- **Цель №2** решается согласованием вылета БВС
- **Цель №3** решается передачей дроном информации о расположении
- **Цель №5** решается передачей дроном информации о расположении
- **Цель №6** решается в момент регистрации БВС проверкой идентфикатора дрона в полетном заданиии

#### Дрон

Реализация: 

Бизнес функции:
1. Получает полетное задание
2. Проходит регистрацию БВС в ОрВД
3. Проверка на взлет
4. Передача нформации о местоположении в ОрВд во время выполнения задания
5. Получение экстренных команд из ОрВд
6. Передача телеметрии в систему планирования полетов
7. Получение управляющих команд из системы планрования полетов
8. Отправка статуса завершения задания в систему планирования полетов

Какие цели безопаност решает:
- **Цель №5** решается отправкой о расположении в ОрВД и передачей в систему управления полетом телеметрии


ТУТ ЗАКОНЧЛИ
## Безопасность
### Выполнение целей безопасности
Рассмотрим поэтапно каждую цель безопасности.

#### 1. обеспечение безопасности дрона от перехвата управления
Перехват управлением может быть по следующим векторам: 
1. взлом мобильного приложения
2. взлом управляющего центра
3. манипуляции с каналом связи между мобильным приложением и дроном
4. манипуляции с каналом связи между управляющим центром и дроном

Манипуляции с каналом связи между мобильным приложением и управляющим центром не рассматриваются, так как они исключительно информативные. Т.е. может произойти подмена информации, но на перехват управлением это не влияет.

Пункты 1 и 2 могут быть реализованы с помощью физического доступа и уязвимостей ПО. Уязвимости ПО будут рассмотрены далее. С точки зрения физического доступа, мобильное приложение защищено PIN-кодом, а доступ от него к дрону - паролем. Считается, что управляющий центр физически находится в защищенном месте.

Пункты 3 и 4 не могут быть реализованы, так как все общение между сервисами происходит через Message Bus, т.е. шину, которая по предположениям безопасности является надежной. Неавторизованный запрос всегда будет отфильтрован монитором безопасности.

#### 2. получение задания только от корпоративного сервера
Данная цель безопасности реализуется с помощью правила SM, который позволяет отправлять задания дрону только от управляющего центра.
Если управляющих центров может быть несколько, то целесообразно реализовать проверку с помощью сертификата (хотя это очень трудоемко для маломощного дрона). В данном проекте считается, что легитимный УЦ только один

#### 3. противодействие Dos-атакам
Неавторизованные запросы к дрону могут приходить:
1. с неизвестного сервиса
2. с мобильного приложения, но без верного пароля (если это чужое мобильное приложение)

В первом случае запросы не будут вообще поступать в дрон, так как будут фильтроваться монитором безопасности.
Для второго случая реализована функция на дроне, которая возвращает дрон на базу (такое решеник было установлено в задании) 

#### 4. (дополнительно) противодействие от взлома мобильного приложения с условием физического доступа

Мобильное приложение защищено PIN-кодом, а доступ к дрону - паролем. Даже в том случае, если PIN-код окажется ненадежным и будет взломан, то подбор пароля к дрону не удастся, т.к. на дроне ограничено количество неавторизованных запросов (см. пункт 3 "противодействие DoS атакам")

#### (без номера). противодействие от взлома дрона с условием физического доступа

Конечно, информационные технологии не смогут защитить дрон от вандалов или хищных птиц. Однако этому пункту хотелось уделить внимание, так как реализованы некоторые функции безопасности, противодействующие физическому снятию информации с носителей. Такие атаки актуальны для устройств в открытом пространстве. При реализации защиты также важно сохранять баланс между требованиями этих реализаций и возможностями самого устройства, т.к. часто дроны являются маломощным.
В данном проекте была реализована одна функция защиты - отсутствие хранения пароля в откртом виде (хорошо было бы добавить "соль", но времени очень не хватало).

### Компрометация сервисов

#### компрометация дрона
Здесь мы не будем рассматривать компрометацию самого дрона, потому что эксплуатация уязвимости дрона может привести к тому, что дрон выполнит неверные команды без какого-либо управления извне. Это необходимо учитывать и, наверное, относить ПО дрона к предположительно доверенным. Или хотя бы его часть, которая выполняет функции безопасности полета.

#### компрометация мобильного приложения
Если проэксплуатировать некую уязвимость в мобильном приложении, то может наступить одно из следующих событий:
1. мобильное приложение не отправило информацию об ошибках в управляющий центр
![B_M1](./diagrams/docs/report/bad_mobile1/bad_mobile1.png?raw=true "Компрометация МП1")
2. мобильное приложение отправляет дрон домой до выполнения задания
![B_M2](./diagrams/docs/report/bad_mobile2/bad_mobile2.png?raw=true "Компрометация МП2")
3. мобильное приложение отправляет управляющему центру информацию об инциденте, которого не было
![B_M3](./diagrams/docs/report/bad_mobile3/bad_mobile3.png?raw=true "Компрометация МП3")
4. мобильное приложение запускает дрон для работы даже в случае ошибок дрона
![B_M4](./diagrams/docs/report/bad_mobile4/bad_mobile4.png?raw=true "Компрометация МП4")

Пункты 1 и 3 имеют место быть. К сожалению, пункт 1 никак нельзя предотвратить. Есть два решения: 
1) Постоянный опрос мобильного приложения (на случай, если информацию просто забыли отправить) и/или самого дрона (на случай, если мобильное приложение умышленно скрывает информацию). С практической точки зрения такое решение не кажется оправданным, т.к. влечет большую нагрузку на все сервисы.
2) Отслеживание завершения заданий со стороны управляющего центра. Т.е. через заданное большое количество времени после выдачи задания и не получения информации о завершении, управляющий центр может "догадаться", что что-то пошло не так. Однако истинную причину ошибки и объем выполненного задания УЦ так и не узнает.
Пункт 3 может быть проверен в мониторе безопасноти: если сообщение об ошибке было отправлено от дрона мобильному приложению, то лишь тогда мобильное приложение может отправлять сообщение об ошибке управляющему центру

Пункт 2 не может быть полностью запрещен, т.к. это разрешенная для мобильного приложения функция. Однако управляющий центр должен получить информацию о том, что задание не было выполнено до конца. Так как мобильное приложение было взломано, то гарантировать это нельзя (см. пункт 1).

Размышления о безопасности пунктов 1-3 наводят на мысль о том, что необходимо изменить последовательность действий в архитектуре. Необходимо отправлять информацию о завершении полета (в том числе об аварийном завершении) управляющему центру не от мобильного приложения, а от самого дрона. Если дрон "не захочет" отправлять информацию о своей работе, то он не отправить ее никому (что снова говорит о том, что ПО дрона не должно содержать закладок и эксплутируемых уязвимостей).
Тогда измененная архитектура будет выглядеть так:
![ARC_CH1](./diagrams/docs/report/arch_ch1/arch_ch1.png?raw=true "Изменения в архитектуре 1")

Тут же возникает вопрос: какие будут последствия, если дрон отправит разные информационные сообщения мобильному приложению и управляющему центру? Информация, полученная мобильным приложением, никак не влияет на дальнейшую логику работы. Поэтому такая ситуация равносильна отправке неверных данных от дрона обоим сторонам. Об этом говорили выше в "компрометации дрона".

Пункту 4 противодействуют реализованные функции безопасности в работе дрона.

#### компрометация управляющего центра
Если проексплуатировать некую уязвимость в управляющем центре, то может наступить одно из следующих событий:
1. управляющий центр выдает неверное/небезопасное задание
![B_CC1](./diagrams/docs/report/bad_cc1/bad_cc1.png?raw=true "Компрометация УЦ1")
2. управляющий центр не регистрирует выполненное задание и/или аварию
3. управляющий центр отправил задание дрону, но не отправил мобильному приложению
![B_CC3](./diagrams/docs/report/bad_cc3/bad_cc3.png?raw=true "Компрометация УЦ3")
4. управляющий центр отправил задание мобильному приложению, но не отправил дрону

![B_CC4](./diagrams/docs/report/bad_cc4/bad_cc4.png?raw=true "Компрометация УЦ4")

Пункт 1 частично покрывается работой дрона, который выполняет проврки функциональоой безопасности. То есть, если было выдано задание распылить химикаты над людьми или над городом, то такое задание не будет выполнено самим дроном. Однако УЦ может выдать задание, которое для дрона будет выглядеть безопасным, хотя это не так. Например, УЦ может несколько раз выдать задание на обработку одного и того же участка. Причем дубликаты заданий могут быть отправлены разным дронам. 
В таком случае можно рассмотреть следующее решение - каждое отправляемое задание при добавлении в пул заданий должно быть подтверждено оператором и заверено цифровой подписью (образованной от секретного ключа оператора и самого задания). Таким образом, злоумышленники не смогут подделывать новые задания без знания секретного ключа оператора. В свою очередь SM должен проверять id заданий, чтобы избежать атаки репликации.
![ARC_CH2](./diagrams/docs/report/arch_ch2/arch_ch2.png?raw=true "Изменения в архитектуре 2")
Пункт 2 не влияет на управление, но может повлиять на восприятие оператором, который будет считать, что задание выполнено, когда оно было выполнено не до конца. Такое поведение нельзя предотвратить, потому что оператор управляющего центра не может взаимодействовать с другими участниками сети.
Для противодействия пункту 3 дрон до начала задания отправляет информационное сообщение мобильному приложению.
Для противодействия пункту 4 мобильное приложение может запросить состояние дрона, чтобы понять, что дрон не работает.

### Рассмотрение других негативных сценариев (из задания) 

#### Физический доступ к смартфону с мобильным приложением

При получении физического доступа к мобильному приложению злоумышленнику необходимо ввести PIN-код, чтобы отправлять команды или получать какие-либо данные

#### Подключение к недоверенному роутеру. Атака через каналы связи

Для противодействия атакам через каналы связи могут быть использованы такие средства защиты как VPN, в том числе шифрование и проверка целостности данных.
В данном проекте вся передача реализуется через Message Bus, которая считается надежной и защищенной

#### Недостаточная защита от подбора учетных данных

Если PIN-код от мобильного приложения был получен путем перебора, то злоумышленник может получить данные о полете, но не сможет управлять дроном, т.к. для этого необходим пароль от дрона.
Пароль от дрона не может быть взломан путем перебора, т.к. в дроне стоит ограничение неавторизованных запросов.
Физический доступ к управляющему центру не рассматривается.

####  Глушение канала передачи информации мобильное приложение <--> дрон

Во время выполнения задания дрон самостоятельно проверяет безопасность полета и в аварийном случае возвращается на базу.

#### Перехват команды/полетного задания и внедрение в него недостоверной информации

Для противодействия атакам через каналы связи могут быть использованы такие средства защиты как VPN, в том числе шифрование и проверка целостности данных.
В данном проекте вся передача реализуется через Message Bus, которая считается надежной и защищенной

#### DDoS-атака на управляющий центр
Неавторизованные запросы будут фильтроваться на уровне монитора безопасности.
Если посылать большое количество информационных сообщений со взломанного дрона/мобильного приложения, то злоумышленнику также необходимо подобрать верный id. Получить id через компрометацию канала связи нельзя, т.к. Message Bus является защищенной.
Количество выданных заданий (т.е. количество id) ограничено, таким образом, можно говорить только о DoS атаке (атака не является распределенной). Управляющий центр должен иметь достаточно ресурсов, чтобы обрабатывать большое количество информации от ограниченного количества участников.

### Итоговые изменения в архитектуре

Рассмотрев множество аспектов безопасности, в архитектуру и логику решения были внесены следующие изменения:
1. Дрон отправляет сообщение о завершении работы не только мобильному приложению, но и управляющему центру. 
2. Задания, поступающие на вход управляющего центра должны быть подписаны оператором
3. Задания должны отслеживаться управляющим центром
4. ПО дрона или хотя бы его часть, отвечающая за функциональную безопасность и аварийное возвращение должна быть свободна от закладок и уязвимостей.
Все изменения были внесены в реализацию проекта. Изменение под пунктом 2 было реализовано примитивным способом.
![ARC_CH_ALL](./diagrams/docs/report/arch_ch_all/arch_ch_all.png?raw=true "Изменения в архитектуре")

## Тестирование

Автоматическое тестирование в данном проекте не предусмотрено. Тестирование можно выполнять вручную с помощью REST-запросов. Примеры таких запросов представлены в файле requests.rest. Основные тестируемые сценарии и их предполагаемый результат будут описаны далее.
Порты: 1234 - дрон, 9876 - мобильное приложение, 5050 - управляющий центр.

### Нормальная работа

В данном пункте описан сценарий штатной работы дрона. 

#### Включение дрона

Прежде всего дрон необходимо включить физически. Предполагается, что питание дрона включается с помощью кнопки на самом дроне, поэтому в данном проекте такое включение реализовано через REST-запрос, направленный самому дрону.
Чтобы включить дрон необходимо выполнить следующий запрос:
POST http://localhost:1234/turn_on HTTP/1.1
content-type: application/json
auth: very-secure-token
{}

Также для тестирования различных состояний дрона в этом же запросе предусмотрена установка таких параметров, как уровень заряда батареи, процентное количество смеси, состояние устройств. Например, чтобы при включении установить уровень заряда батареи в 50%, необходимо направить следующий запрос:
POST http://localhost:1234/turn_on HTTP/1.1
content-type: application/json
auth: very-secure-token
{
	"charge":"50"
}

В качестве ответа на первый и второй запрос, дрон переведет свое состояние на "включено" и отобразить текущие параметры.
P.S. В текущей реализации процедуру включения можно опустить, на данный момент это не влияет на выполнение заданий дроном. Это было сделано для упрощения тестирования.

#### Создание заданий

Далее необходимо добавить одно или несколько заданий в управляющий центр. Добавление происходит с помощью REST-запросов, так как предполагается, что запросы добавляются оператором. Также запрос должен содержать цифровую подпись. Для простоты реализации на данный момент в проекте используется не криптографический примитив в качестве цифровой подписи, а строка с ФИО.
Таким образом, следующий пример добавляет задание с начальными координатами (X:Y:Z) - (7:8:9) и конечными (X:Y:Z) - (10:11:12). Размерность условная.
POST http://localhost:5050/add_task HTTP/1.1
content-type: application/json
auth: very-secure-token
{
"X_start":"7",
"Y_start":"8",
"Z_start":"9",
"X_end":"10",
"Y_end":"11",
"Z_end":"12",
"sign":"IvanovII"
}

Так как в управляющий центр можно добавлять несколько заданий (для этого надо отправить несколько запросов с соответствующими координатами), то управляющий центр выведет на экран количество уже добавленных запросов.
P.S.1: несмотря на то, что вводится Z-координата и начала, и конца, дрон доходит только до стартовой Z-координаты, после чего обрабатывает квадрат (а не куб). Таким образом, конечная Z-координата не используется и является рудиментом.
P.S.2: Внимание! В текущей реализации используется cheat-функция, устанавливающая, что на координате (5:5) расположен человек. Поэтому, если ваш квадрат-задание будет включать данную точку, то дрон не выполнить его и отправится домой,сигнализируя об ошибке.

#### Запуск для работы

Когда дрон включен, а задание добавлены в управляющий центр, можно запустить дрон для работы с помощью мобильного приложения. Выполнить это можно с помощью REST-запроса. Получить доступ к мобильному приложению можно только с помощью PIN-кода. А для того, чтобы запустить дрон, необходимо знать от него пароль. Таким образом, следующий запрос, включающий эти секретные параметры, запускает дрон для работы:
POST http://localhost:9876/drone_work HTTP/1.1
content-type: application/json
auth: very-secure-token
{
"PIN":"1234",
"drone_password":"password"
}

При получении данного запроса мобильное приложение, проверив PIN-код, отправляет сообщение дрону о запуске. Дрон отправляет мобильному приложению информацию о своем состоянии, которую мобильное приложение отображает на экране (в качестве ответа на REST-запрос), а также отправляет запрос управляющему центру для получения задания. Управляющий центр отвечает сообщением с заданием дрону и отправляет копию мобильному приложению, после чего дрон проверяет корректность задания. Каждый этап отображается в логах соответствующих сторон.
Если пул заданий управляющего центра был пустой, то управляющий центр отправит пустое задание, что расценивается дроном как некорректное задание.
Некорректное задание будет рассматриваться в следующих пунктах.
Если задание проверено, то в логах дрона будет отображена строка "task is good", после чего дрон сразу же отправляется на задание.
Для выполнения задания дрон сначала отправляется на стартовую точку. Смещение на одну координату выполняется один раз в секунду. Каждое смещение фиксируется в логах. Как только дрон окажется на стартовой точке, создатся запись в логах о начале работы. С этого момента дрон начнет двигаться "змейкой" по заданному квадрату, также со скоростью одна координата/секунда. Каждое смещение аналогично будет публиковаться в логах. Как только задание будет выполнено, дрон отправит оповещение об успешному завершении мобильному приложению, управляющему центру и своему лог-журналу, после чего отправится на базу.

#### Получение информации о полете с мобильного телефона

Во время полета, а также во время пребывания на базе мобильное приложение может запрашивать статус полета (или просто статус дрона).
Выполнить это можно с помощью следующего запроса:
POST http://localhost:9876/drone_status HTTP/1.1
content-type: application/json
auth: very-secure-token
{
"PIN":"1234",
"drone_password":"password"
}

Для этого запроса также необходим PIN-код от мобильного устройства и пароль от дрона.
Мобильное приложение отправит запрос статуса дрону, а полученный ответ выведет в качестве ответа на REST-запрос. Если дрон выключен (физически), то это будет единственная информация, которую мобильное приложение получит с дрона.
Если дрон включен, но не отправлен на задание, то дрон вернет информацию о своем состоянии (уровень заряда, уровень смеси, состояние устройств текущее местоположение).
Если дрон находится в полете, то мобильное приложение (дополнительно к информации о состоянии дрона) получит информацию о задании: начато задание или дрон только отправляется на стартовую точку, где сейчас находится дрон и какая часть задания (в процентном соотношении) уже выполнена.
Дополнительно, если во время предыдущего полета была обнаружена какая-то ошибка, то дрон вернет информацию и о ней.

#### Принудительное возвращение на базу

Мобильное приложение может принудительно отправить дрон на базу во время задания. Внимание! Такое поведение является инцидентом, так как задание начато, но не выполнено. То есть мобильное приложение и управляющий центр получат информацию об ошибке задания. Вернуть дрон можно с помощью следующего запроса:

POST http://localhost:9876/drone_to_home HTTP/1.1
content-type: application/json
auth: very-secure-token
{
"PIN":"1234",
"drone_password":"password"
}

#### Просмотр журналов управляющего центра об инцидентах
Управляющий центр хранит информацию обо всех произошедших инцидентах всех полетов. Чтобы просмотреть этот журнал, необходимо выполнить следующий запрос:
GET http://localhost:5050/incident_info HTTP/1.1

### Cheat-запросы и функции

Так как в данном проекте был реализован только прототип дрона, для проверки нештатных ситуаций были разработаны cheat-функции и запросы, которые позволяют выполнить эмуляцию ошибок. Про некоторые уже упоминалось ранее, однако здесь они были собраны воедино.

#### Состояние дрона

Как уже говорилось ранее, при включении питания дрона, можно установить его параметры. Но важно дополнительно отметить, что менять эти параметры можно и во время полета. Например, если вы включили дрон и отправили его на задание, то во время выполнения можно выполнить следующий запрос:
POST http://localhost:1234/turn_on HTTP/1.1
content-type: application/json
auth: very-secure-token
{
	"charge":"2"
}

Это будет восприниматься как резкое снижение уровня заряда батареи до 2%. Дрон считает, что на каждые 10 смещений по координатам уходит 1% заряда. Тогда, как только дрону будет необходимо как минимум 20 смещений, чтобы вернуться на базу, он прервет задание, отправит сообщение мобильному приложению и управляющему центру об ошибке и вернется домой.

#### Ошибка GPS навигации

В проекте реализована функция, которая выполняет роль GPS навигации. Для этой функции был создан cheat-флаг, который используется для эмуляции ошибки навигации. Установить этот флаг можно с помощью cheat-запроса:
GET http://localhost:1234/bad_GPS HTTP/1.1

Флаг сбрасывается автоматически.
При ошибке навигации, дрон отправляет информацию об ошибке мобильному приложению и управляющему центру и отправляется на базу.

#### Человек под дроном
В проекте создан прототип функции, который возвращает расстояние от дрона до поверхности земли, чтобы определять, нет ли под дроном человека, животного или здания. Прототип очень примитивен и возвращает всегда одно значение, кроме координаты (5:5). Эта cheat-координата используется для проверки действий дрона, если под ним находится объект.
Дополнительных запросов не требуется.
Если отправить на УЦ следующий запрос, дрон не выполнит задание до конца и вернется на базу с ошибкой:
POST http://localhost:5050/add_task HTTP/1.1
content-type: application/json
auth: very-secure-token
{
"X_start":"1",
"Y_start":"2",
"Z_start":"3",
"X_end":"10",
"Y_end":"11",
"Z_end":"12",
"sign":"IvanovII"
}

Внимание! Данная проверка не актуальная на протяжении движения до старта, так как дрон может пролететь над объектами, пока не началось распыление химикатов.

### DoS-атака

В дроне установлен следующий параметр: если произошло 5 неавторизованных запросов (т.е. с неправильным паролем), то такая ситуация расценивается как DoS-атака и является инцидентом. Дрон отправляется на базу, не закончив задание. 
Внимание! Этот параметр нельзя сбросить вручную, поэтому для сброса необходимо перезапустить докер-образ дрона.
Для возникновения такой ситуации можно выполнить 5 или более следующих запросов с мобильного приложения:
POST http://localhost:9876/drone_work HTTP/1.1
content-type: application/json
auth: very-secure-token
{
"PIN":"1234",
"drone_password":"paссword"
}

Какой именно запрос - неважно, можно также выполнить 5 запросов состояний.

### Обработка ошибок

Во время полета дрона могут наступить следующие проблемы:
1. Состояние дрона не позволяет закончить задание (низкий заряд аккумулятора, неисправность устройств, низкий объем смеси)
2. Задание некорректно
3. Ошибка навигации
4. Объект под дроном (только во время распыления)
5. Принудительное возвращение
6. DoS-атака

Если одна из этих ошибок наступает, то дрон отправляет информацию об ошибке мобильному приложению и управляющему центру. Такие письма будут иметь тип операции "job_error", а также будут включать информацию о типе ошибке (поле "type_error") и дополнительную информацию в зависимости от типа ошибки. Например, процент выполнения задания, координаты, где произошла ошибка и т.п. После отправки сообщения дрон направляется на базу (кроме случая некорректного задания, тут дрон просто не начинает его).
Типы ошибок:
1. Ошибка состояния дрона - "low_charge"
2. Задание некорректно - "bad_task"
3. Ошибка навигации - "GPS_error"
4. Объект под дроном - "human"
5. Принудительное возвращение - "home"
6. DoS-атака - "dos"
